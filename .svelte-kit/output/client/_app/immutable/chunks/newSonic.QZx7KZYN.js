var S=Object.defineProperty;var D=(c,n,e)=>n in c?S(c,n,{enumerable:!0,configurable:!0,writable:!0,value:e}):c[n]=e;var g=(c,n,e)=>D(c,typeof n!="symbol"?n+"":n,e);import{o as I,j as x,k as V,S as K,T as d,p as k,q as C,l as b,r as R,u as Y,v as p,s as P,x as m}from"./2.Bt4yhKeu.js";const w={DefaultLine:{Synth:"Synth",Presets:{envelope:{decay:0,sustain:1,release:.5},oscillator:{count:8,spread:30,type:"sawtooth4"}}},Click:{Synth:"Synth",Presets:{envelope:{attack:0,decay:.1,sustain:0,release:.1},oscillator:{modulationFrequency:.2,type:"sine"}}},Kalimba:{Synth:"FMSynth",Presets:{harmonicity:8,volume:5,modulationIndex:2,oscillator:{type:"sine"},envelope:{attack:.001,decay:2,sustain:.1,release:2},modulation:{type:"square"},modulationEnvelope:{attack:.002,decay:.2,sustain:0,release:.2}}}};function B(c,n,e){let s=n;if(x(c,"interval"))console.log("user has defined the interval"),s=c.interval;else if(e)return e.timescale;return s}function F(c){let n=20,e=.2;return e*c<=n||(e*c>n&&(e=.1),e*c<=n)||(e=n/c),e}const v=c=>new Promise(n=>setTimeout(n,c)),A={xColumn:null,audioRendering:null,invertY:null,type:null,interval:null,xFormat:{date:null,string:null,number:null,status:"",type:null}},T=I(["red"]);class L{constructor({data:n,dataKeys:e=[],chartID:s=null,controlsID:t=t,settings:i=A,animationID:a=null,x:r=null,y:o=null,colors:f=T}){g(this,"playAudio",n=>new Promise(async(e,s)=>{let t=this,i=t.dataKeys.indexOf(n);d.stop(),d.cancel(),t.audioRendering=="discrete"&&(t.synth.sync(),t.click.sync());let a=t.sonicData[n];t.currentIndex!=0&&(a=a.slice(t.currentIndex));for(let r=0;r<a.length;r++){const o=a[r];t.currentKey=n,t.audioRendering=="discrete"?(o[n]?t.synth.triggerAttackRelease(t.scale(o[n]),t.note,t.note*r):t.click.triggerAttackRelease(440,t.note,t.note*r),d.schedule(function(){t.currentIndex=o.sonic_index,t.animationID&&o[n]&&t.animateCursor(n,o.sonic_index,null)},r*t.note)):t.audioRendering=="continuous"?r==0?synth.triggerAttackRelease(t.scale(o[key]),a[n].length*t.note):d.schedule(function(){t.synth.frequency.rampTo(scale(o[n]),t.note)},r*t.note):t.audioRendering=="categorical"&&(await t.speaker(o[t.xVar]),t.animationID&&t.animateCursor(n,r,null),await t.beep(t.scale(o[n])))}d.schedule(function(){t.currentIndex=0,t.isPlaying=!1,e({status:"success"})},a.length*t.note),i===t.dataKeys.length-1&&d.schedule(function(){t.inProgress=!1,t.usedCursor=!1},a.length*t.note),d.position="0:0:0",d.start(),t.inProgress=!0,t.isPlaying=!0}));g(this,"playFurniture",()=>new Promise((n,e)=>{let s=this;async function t(){let i=s.domainY[0],a=s.domainY[1];"invertY"in s.settings&&s.settings.invertY&&(i=s.domainY[1],a=s.domainY[0]);let r=s.domainX[0],o=s.domainX[1],f=r,l=o;s.settings.xFormat.date&&(f=m(s.domainX[0],s.timeSettings.suggestedFormat),l=m(s.domainX[1],s.timeSettings.suggestedFormat));let u=i,y=a;typeof i=="number"&&(u=p(i),y=p(a)),s.furniturePlaying=!0,await s.speaker(`The lowest value on the chart is ${u}, and it sounds like `),s.animationID&&s.animateCircle(s.lowestVal[s.xVar],s.lowestVal.value,s.lowestVal.key),await s.beep(s.scale(i)),await v(1200),await s.speaker(`The highest value on the chart is ${y}, and it sounds like `),s.animationID&&s.animateCircle(s.highestVal[s.xVar],s.highestVal.value,s.highestVal.key),await s.beep(s.scale(a)),await v(1200),(s.audioRendering=="discrete"||s.audioRendering=="continuous")&&await s.speaker(`Each note is a ${s.interval}, and the chart goes from ${f} to ${l}`),s.furniturePlaying=!1,n({status:"success"})}t()}));g(this,"handleKeyPress",n=>{let e=this;console.log(n.code),e.synthLoaded||e.setupSonicData(e.data,e.keys),n.code==="Space"&&this.playPause(),n.code==="KeyD"&&(console.log("keyd"),e.moveCursor(1)),n.code==="KeyA"&&e.moveCursor(-1),n.code==="KeyW"&&e.moveSeries(1),n.code==="KeyS"&&e.moveSeries(-1),n.code==="KeyR"&&e.restart()});console.log(i),this.settings=i,this.animationID=a,this.chartID=s,this.controlsID=t,this.data=n,this.synthLoaded=!1,this.x=r,this.y=o,this.colors=f,this.synth=null,this.isPlaying=!1,this.hasRun=!1,this.currentKey=null,this.currentIndex=0,this.note=.2,this.sonicData={},this.interval=null,this.timeSettings=null,this.domainX=null,this.domainY=null,this.xVar=null,this.isPlaying=!1,this.inProgress=!1,this.scale=null,this.dataKeys=null,this.speech=window.speechSynthesis,this.furniturePlaying=!1,this.furniturePaused=!1,this.usedCursor=!1,this.audioRendering="discrete",this.keys=e,this.interactionAdded=!1;let l=x(this.x,"bandwidth");l&&(l=l());let u=x(this.y,"bandwidth");u&&(u=u()),this.xBand=l,this.yBand=u}loadSynth(n){let e=w[n],s=e.Synth,t=e.Presets,i=new V[s](t).toDestination();this.synth=i;let a=w.Click;this.click=new K(a.Presets).toDestination()}beep(n){return new Promise((e,s)=>{d.stop(),d.cancel();let t=this.synth;t.unsync(),t.triggerAttackRelease(n,.5),setTimeout(i,500);function i(){e({status:"success"})}})}speaker(n){return new Promise((e,s)=>{let t=this;if("speechSynthesis"in window){var i=new SpeechSynthesisUtterance;i.text=n,i.lang="en-GB";let a=k();a=="Firefox"&&(i.rate=1.1,i.lang="en-AU"),a=="Safari"&&(i.rate=1.1),t.speech.speak(i),i.onend=function(){e({status:"success"})}}else e({status:"no txt to speach"})}).catch(function(e){reject(e)})}setupSonicData(n,e=[],s=[]){console.log("Setting up data and synth");let t=this;t.note=F(n.length);const i=this.settings.xFormat;t.settings.audioRendering&&(t.audioRendering=t.settings.audioRendering),t.audioRendering=="continuous"?t.loadSynth("DefaultLine"):t.loadSynth("Kalimba"),t.synth,t.click,t.hasRun;let a=Object.keys(n[0]);t.xVar=a[0],i.date&&(t.timeSettings=C(n,t.settings)),t.interval=B(t.settings,t.xVar,t.timeSettings);let r=[];e.length===0&&(e=a.slice(1)),t.dataKeys=e,t.currentKey=e[0];let o=t.xVar;t.lowestVal={key:e[0],value:n[0][e[0]],[o]:n[0][t.xVar]},t.highestVal={key:e[0],value:n[0][e[0]],[o]:n[0][t.xVar]},e.forEach(function(l){t.sonicData[l]=[],n.forEach((u,y)=>{if(u[l]!=null){let h={};h[t.xVar]=u[t.xVar],h[l]=u[l],h.sonic_index=y,t.sonicData[l].push(h),r.push(u[l]),h[l]>t.highestVal.value&&(t.highestVal.key=l,t.highestVal.value=u[l],t.highestVal[o]=u[t.xVar]),h[l]<t.lowestVal.value&&(t.lowestVal.key=l,t.lowestVal.value=u[l],t.lowestVal[o]=u[t.xVar])}else{let h={};h[t.xVar]=u[t.xVar],h[l]=u[l],h.sonic_index=y,t.sonicData[l].push(h)}})});let f=[130.81,523.25];t.domainY=d3.extent(r),t.domainX=d3.extent(n,l=>l[t.xVar]),"invertY"in this.settings&&this.settings.invertY&&(f=f.reverse()),t.scale=b().domain(t.domainY).range(f),t.synthLoaded=!0}async playPause(){let n=this;if(n.synthLoaded||n.setupSonicData(n.data,n.keys),R.resume(),console.log("isPlaying",n.isPlaying,"inProgress",n.inProgress,"usedCursor",n.usedCursor,"furniturePlayer",n.furniturePlaying,"furniturePaused",n.furniturePaused),!n.runOnce&&!n.inProgress&&!n.furniturePlaying?(console.log("playing furniture"),Y(),n.synth.context.resume(),n.runOnce=!0,await n.playFurniture()):n.furniturePlaying&&!n.furniturePaused?(console.log("pausing furniture"),n.speech.pause(),n.furniturePaused=!0):n.furniturePlaying&&n.furniturePaused&&(n.speech.resume(),n.furniturePaused=!1),!n.isPlaying&&!n.inProgress&&!n.usedCursor&&!n.furniturePlaying){console.log("playing");for await(const e of this.dataKeys)console.log(e),await n.speaker(`${e}`),await n.playAudio(e)}else if(!n.isPlaying&&n.inProgress&&n.usedCursor){console.log("playing from cursor"),console.log("yeh");let e=n.dataKeys.indexOf(n.currentKey);for(let s=e;s<n.dataKeys.length;s++)n.currentKey=n.dataKeys[s],await n.speaker(`${n.currentKey}`),await n.playAudio(n.currentKey)}else n.isPlaying&&n.inProgress?(console.log("pause"),n.isPlaying=!1,d.pause()):!n.isPlaying&&n.inProgress&&(console.log("restart"),n.isPlaying=!0,d.start())}async moveCursor(n){let e=this;e.synthLoaded||e.setupSonicData(e.data,e.keys),e.usedCursor=!0,e.isPlaying=!1,e.inProgress=!0,console.log("Move cursor",n),d.pause(),e.currentIndex=e.currentIndex+n,e.currentIndex>=e.sonicData[e.currentKey].length&&(e.currentIndex=0),e.currentIndex<0&&(e.currentIndex=e.sonicData[e.currentKey].length-1);let s=e.sonicData[e.currentKey][e.currentIndex],t=s[e.xVar],i=s[e.currentKey];function a(){e.speaker(m(t,e.timeSettings.suggestedFormat)),e.speaker(p(i)),e.animationID&&e.animateCursor(e.currentKey,e.currentIndex,null),e.beep(e.scale(i))}e.speech.speaking?(e.speech.cancel(),setTimeout(()=>{a()},100)):a()}moveSeries(n){let e=this;e.synthLoaded||e.setupSonicData(e.data,e.keys),e.usedCursor=!0,e.isPlaying=!1,e.inProgress=!0,d.pause();let s=e.dataKeys.indexOf(e.currentKey);s=s+n,s>=e.dataKeys.length&&(s=0),s<0&&(s=e.dataKeys.length-1),e.currentKey=e.dataKeys[s];let t=e.sonicData[e.currentKey][e.currentIndex];t[e.xVar];let i=t[e.currentKey];e.speaker(e.currentKey),e.speaker(p(i)),e.animationID&&e.animateCursor(e.currentKey,e.currentIndex,null),e.beep(e.scale(i))}restart(){console.log("restart");let n=this;d.pause(),n.isPlaying=!1,n.inProgress=!1,n.runOnce=!1,n.furniturePlaying=!1,n.furniturePaused=!1,n.usedCursor=!1,n.currentKey=n.dataKeys[0],n.currentIndex=0,n.playPause()}addInteraction(n=null){let e=this;if(!e.interactionAdded){if(e.chartID){let t=document.getElementById(e.chartID);t.tabIndex=0,t.addEventListener("click",i=>{e.synthLoaded||e.setupSonicData(e.data,e.keys)}),t.addEventListener("keypress",this.handleKeyPress)}const s=[{id:"play",text:"play/pause",function:()=>e.playPause()},{id:"restart",text:"restart",function:()=>e.restart()},{id:"datumNext",text:"cursor forward",function:()=>e.moveCursor(1)},{id:"datumPrevious",text:"cursor back",function:()=>e.moveCursor(-1)},{id:"seriesNext",text:"series forward",function:()=>e.moveSeries(1)},{id:"seriesBack",text:"series back",function:()=>e.moveSeries(1)}];if(n){let t=document.getElementById(n);t.innerHTML="",s.forEach(a=>{let r=document.createElement("button");r.textContent=a.text,r.onclick=a.function,r.id=a.id,r.id=a.id,t.appendChild(r)}),document.getElementById("play").addEventListener("keyup",a=>{a.code==="Space"&&a.preventDefault()})}e.interactionAdded=!0}}animateCursor(n,e,s){let t=this,i=t.sonicData[n],a=t.settings.type,r=t.y(i[e][n]),o=t.x(i[e][t.xVar]);a=="horizontalbar"&&(r=t.y(i[e][t.xVar]),o=t.x(i[e][n])),P(`#${t.animationID}`).append("circle").attr("cy",r+t.yBand/2).attr("fill",t.colors(n)).attr("cx",o+t.xBand/2).attr("r",0).style("opacity",1).transition().duration(300).attr("r",40).style("opacity",0).remove()}animateCircle(n,e,s=null){let t=this,i=t.settings.type;s||(s=t.currentKey);let a=e,r=n;i=="horizontalbar"&&(a=n,r=e),P(`#${t.animationID}`).append("circle").attr("cy",t.y(a)+t.yBand/2).attr("fill",t.colors(s)).attr("cx",t.x(r)+t.xBand/2).attr("r",0).style("opacity",1).transition().duration(300).attr("r",40).style("opacity",0).remove()}}export{L as default};
